<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIL Data Explorer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#4f46e5',
                        'brand-secondary': '#10b981',
                        'bg-light': '#f9fafb',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .chart-container {
            min-height: 400px;
            max-height: 70vh;
        }
        canvas {
            max-height: 100%;
            width: 100% !important;
            height: auto !important;
        }
    </style>
</head>
<body class="bg-bg-light min-h-screen p-4 sm:p-8 font-sans">

    <div id="app" class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10 p-4 bg-white shadow-lg rounded-xl">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                Expected Impermanent Loss (EIL) Time Series Explorer
            </h1>
            <p class="text-lg text-gray-600">
                Visualizing EIL metrics with automated hourly data refresh.
            </p>
        </header>

        <!-- Main Content Card -->
        <div class="bg-white shadow-xl rounded-xl p-6 sm:p-10 border border-gray-100">

            <!-- Chart Visualization -->
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">EIL Over Last 24 Hours</h2>
            <div class="chart-container mb-8">
                <canvas id="eilChart"></canvas>
            </div>

            <!-- Status and Control Panel -->
            <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                    <div id="status" class="text-sm font-medium text-gray-600">
                        Status: Initializing...
                    </div>
                    <button 
                        onclick="fetchAndRenderData(true)" 
                        class="px-4 py-2 bg-brand-primary text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-300 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 flex items-center justify-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2.153m15.357 2.153H15"></path></svg>
                        Manual Refresh
                    </button>
                </div>
            </div>

            <!-- JavaScript Logic -->
            <script type="text/javascript">
                let eilChart;

                /**
                 * Generates mock data for the EIL time series (last 24 hours).
                 * In a production environment, this function would call the actual API.
                 * @returns {Array<Object>} Array of data points { timestamp: string, value: number }
                 */
                const generateMockData = () => {
                    const data = [];
                    const now = Date.now();
                    // Generate data points for the last 24 hours (24 points)
                    for (let i = 23; i >= 0; i--) {
                        const date = new Date(now - (i * 3600000)); // Subtract i hours
                        const value = 0.5 + Math.sin(date.getTime() / (1000 * 3600 * 4)) * 0.2 + (Math.random() * 0.1);
                        data.push({
                            timestamp: date.toISOString(),
                            value: Math.max(0, parseFloat(value.toFixed(4))) // Ensure non-negative
                        });
                    }
                    return data;
                };

                /**
                 * Fetches (simulates) the EIL data and updates the Chart.js instance.
                 * @param {boolean} isManual - Flag indicating a manual refresh.
                 */
                const fetchAndRenderData = async (isManual = false) => {
                    const statusEl = document.getElementById('status');
                    
                    // --- START LIVE UPDATE VISUAL CUE ---
                    statusEl.classList.add('text-brand-primary', 'font-bold', 'animate-pulse');
                    statusEl.textContent = isManual ? "Status: Fetching and redrawing chart (Manual)..." : "Status: Automated live data update in progress...";
                    // ------------------------------------
                    
                    try {
                        // --- API INTEGRATION POINT ---
                        // FUTURE MODIFICATION: Replace generateMockData() with actual fetch call.
                        // const response = await fetch('YOUR_REAL_API_ENDPOINT');
                        // const rawData = await response.json();
                        const rawData = generateMockData();
                        // -----------------------------

                        const labels = rawData.map(d => new Date(d.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                        const dataPoints = rawData.map(d => d.value * 100); // Convert to percentage for display

                        if (eilChart) {
                            // Update existing chart
                            eilChart.data.labels = labels;
                            eilChart.data.datasets[0].data = dataPoints;
                            eilChart.update();
                        } else {
                            // Initialize chart
                            const ctx = document.getElementById('eilChart').getContext('2d');
                            eilChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'EIL (%)',
                                        data: dataPoints,
                                        borderColor: 'rgb(75, 192, 192)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        tension: 0.4,
                                        fill: true,
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Expected Impermanent Loss (%)'
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: { display: false },
                                        title: {
                                            display: true,
                                            text: 'EIL Time Series (Last 24 Hours)',
                                            font: { size: 16, weight: 'bold' }
                                        }
                                    }
                                }
                            });
                        }

                        statusEl.textContent = `Status: Data last updated at ${new Date().toLocaleTimeString()}. Automated refresh scheduled.`;

                    } catch (error) {
                        console.error("Error fetching or rendering EIL data:", error);
                        statusEl.textContent = `Status: Error updating data at ${new Date().toLocaleTimeString()}. See console for details.`;
                    } finally {
                        // --- END LIVE UPDATE VISUAL CUE (Clean up) ---
                        statusEl.classList.remove('text-brand-primary', 'font-bold', 'animate-pulse');
                    }
                };
                
                /**
                 * Sets up the hourly refresh mechanism to align with the top of the hour (00:00:00).
                 */
                const setupHourlyRefresh = () => {
                    const now = new Date();
                    const nextHour = new Date(now);
                    nextHour.setHours(now.getHours() + 1, 0, 0, 0); // Set to the start of the next hour

                    // Calculate initial delay
                    const initialDelay = nextHour.getTime() - now.getTime();
                    
                    console.log(`Current Time: ${now.toLocaleTimeString()}`);
                    console.log(`Next Refresh Scheduled For: ${nextHour.toLocaleTimeString()}`);
                    console.log(`Initial Delay: ${Math.round(initialDelay / 1000)} seconds`);

                    // 1. Run the initial data fetch immediately on load
                    fetchAndRenderData();

                    // 2. Set timeout for the first run at the top of the hour
                    setTimeout(() => {
                        // Run fetch on the first timeout
                        fetchAndRenderData();

                        // 3. Set interval for subsequent hourly runs (3600000ms = 1 hour)
                        setInterval(fetchAndRenderData, 3600000);

                    }, initialDelay);
                };

                // Initialize the application and start the refresh mechanism
                window.onload = setupHourlyRefresh;

            </script>
        </div>
    </div>
</body>
</html>
